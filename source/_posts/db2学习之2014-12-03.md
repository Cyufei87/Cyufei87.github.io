---
title: db2学习之2014.12.03
tags:
  - 技术探索
date: 2014-12-03 18:48:07
---

2014.12.02，db2 crash..

我并不是专门负责db2管理的，出于兴趣，还是去探索了下...

网上一通搜索，定位了问题应该是下面中的一个：

1\. linux服务器某些限制，如限制进程创建的线程数，使用到的最大虚拟内存

2\. db2配置的问题，过多的客户端程序连接db2 server，导致超过了db2本身的最大agents(连接)数.

又一桶搜索，加上稍稍的分析，慢慢的特别聚焦到第二个原因上的..

通过命令db2 get snapshot for database manager，发现db2的连接数在170左右，而查看db2配置(db2 get dbm cfg)，发现输出中有下面两句：

Max number of coordinating agents     (MAX_COORDAGENTS) = AUTOMATIC(200)

Max number of client connections      (MAX_CONNECTIONS) = AUTOMATIC(MAX_COORDAGENTS)

看见了200这个数，比较170，感觉的确相差不多...

唯一说不通的是，在其他linux服务器上的db2(同样的数据库，同样的应用)为什么从没出现过类似情况？

用命令db2 list applications show detail查看详细数据库的连接情况，发现crash的db2的本地连接远多于其他的服务器...

进一步分析输出，发现db2对于每个database都有差不多30个的本地连接，而未crash的db2只有大约10个...

我们的db2上创建了3个database，算起来就多了差不多3*20个的连接，似乎可以解释了

实际上，是因为crash的db2的linux服务器实在太好了...24核的...而其他的linux服务器是4核的...

db2会根据linux服务器的虚拟cpu数来创建db2fw线程..导致对于每个database多创建了20个db2fw，也多了20个agents(连接)..

经过进一步的探查..

最大agents的数目其实并不是200，前面有个AUTOMATIC，db2会根据数据库的负载，适当增加这个数目..

而一个client connection也并不一定对应一个coordinating agent...

昨天写过一个shell脚本来定时监测agents数目，发现在23:18左右，agents数据实际是超过了200的...而db2并未崩溃...

昨天crash的原因也许并不在此...

说些“题外话”把..我其实并不想花费太多时间在这个上边..db2在国内，除了IBM自己..有多少IT企业在用呢？