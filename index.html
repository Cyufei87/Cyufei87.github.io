<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="和平，宁静，奋斗">
<meta property="og:type" content="website">
<meta property="og:title" content="zhaohui&#39;s 小站">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="zhaohui&#39;s 小站">
<meta property="og:description" content="和平，宁静，奋斗">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="zhaohui&#39;s 小站">
<meta name="twitter:description" content="和平，宁静，奋斗">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.2',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>zhaohui's 小站</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">zhaohui's 小站</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/11/29/Python的闭包/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhaohui">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhaohui's 小站">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/29/Python的闭包/" itemprop="url">Python的闭包</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-11-29T14:53:42+08:00">
                2017-11-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术探索/" itemprop="url" rel="index">
                    <span itemprop="name">技术探索</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>来自<a href="https://zh.wikipedia.org/wiki/%E9%97%AD%E5%8C%85_%28%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6%29" target="_blank" rel="external">维基百科</a>：</p>
<blockquote>
<p>在计算机科学中，闭包（英语：Closure），又称词法闭包（Lexical Closure）或函数闭包（function closures），是引用了自由变量的函数。这个被引用的自由变量将和这个函数一同存在，即使已经离开了创造它的环境也不例外。所以，有另一种说法认为闭包是由函数和与其相关的引用环境组合而成的实体。闭包在运行时可以有多个实例，不同的引用环境和相同的函数组合可以产生不同的实例。</p>
</blockquote>
<p><strong>Python的闭包的环境信息保存在函数对象的属性__closure__中</strong><br>测试代码：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line">global_var = <span class="number">100</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">add1</span><span class="params">(a, b)</span>:</span></div><div class="line">    <span class="keyword">return</span> global_var + a + b</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_one</span><span class="params">(b)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">real_add</span><span class="params">(a)</span>:</span></div><div class="line">        <span class="keyword">return</span> global_var + a + b</div><div class="line">    <span class="keyword">return</span> real_add</div><div class="line">add2 = add_one(<span class="number">2</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_one_default</span><span class="params">(default_b)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">real_add_default</span><span class="params">(a, b=default_b)</span>:</span></div><div class="line">        <span class="keyword">return</span> global_var + a + b</div><div class="line">    <span class="keyword">return</span> real_add_default</div><div class="line">add3 = add_one_default(<span class="number">3</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_global_deco</span><span class="params">(func)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_func</span><span class="params">(*args, **kwargs)</span>:</span></div><div class="line">        <span class="keyword">return</span> func(*args, **kwargs) + global_var</div><div class="line">    <span class="keyword">return</span> _func</div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@add_global_deco</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">add4</span><span class="params">(a, b)</span>:</span></div><div class="line">    <span class="keyword">return</span> a + b</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    print(<span class="string">"add1.__closure__ is %s"</span> % repr(add1.__closure__))</div><div class="line">    <span class="comment"># add1.__closure__ is None</span></div><div class="line">    print(<span class="string">"add2.__closure__ is %s"</span> % repr(add2.__closure__))</div><div class="line">    <span class="comment"># add2.__closure__ is (&lt;cell at 0x10437a7f8: int object at 0x7fea2e605460&gt;,)</span></div><div class="line">    print(<span class="string">"add3.__closure__ is %s"</span> % repr(add3.__closure__))</div><div class="line">    <span class="comment"># add3.__closure__ is None</span></div><div class="line">    print(<span class="string">"add4.__closure__ is %s"</span> % repr(add4.__closure__))</div><div class="line">    <span class="comment"># add4.__closure__ is (&lt;cell at 0x10437a830: function object at 0x104377578&gt;,)</span></div></pre></td></tr></table></figure></p>
<p>可以看出add2、add4是闭包，add1、add3不是</p>
<p><strong>在嵌套函数中，子函数只有引用了locals()中的自由变量才能成为闭包</strong><br>Python关于自由变量的<a href="https://docs.python.org/2/reference/executionmodel.html" target="_blank" rel="external">文档</a>：</p>
<blockquote>
<p>If a name is bound in a block, it is a local variable of that block. If a name is bound at the module level, it is a global variable. (The variables of the module code block are local and global.) If a variable is used in a code block but not defined there, it is a free variable.</p>
</blockquote>
<p>Python关于locals()的<a href="https://docs.python.org/2/library/functions.html#locals" target="_blank" rel="external">文档</a>：</p>
<blockquote>
<p>Update and return a dictionary representing the current local symbol table. Free variables are returned by locals() when it is called in function blocks, but not in class blocks.</p>
</blockquote>
<p>注：这里有歧义，按照自由变量的定义，全局变量也应该属于自由变量。但是，全局变量并不会通过locals()返回，而是通过globals()返回</p>
<p>add1在locals()没有自由变量，所以不能形成闭包<br>add2有自由变量b，所以形成闭包<br>add3在函数定义中引用了default_b，但是在执行中并未用到（这里的b是局部变量），所以也不能形成闭包<br>add4是装饰器形式的闭包，这里的自由变量是被装饰的函数add4，所以形成闭包</p>
<p>参考：<br><a href="https://gist.github.com/DmitrySoshnikov/700292" target="_blank" rel="external">Understanding Python’s closures</a><br><a href="http://mathamy.com/python-closures-and-free-variables.html" target="_blank" rel="external">Python Closures and Free Variables</a><br><a href="https://segmentfault.com/a/1190000004461404" target="_blank" rel="external">Python 的闭包和装饰器</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/11/18/Python-2-vs-Python-3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhaohui">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhaohui's 小站">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/18/Python-2-vs-Python-3/" itemprop="url">Python 3 vs Python 2</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-11-18T14:24:15+08:00">
                2017-11-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术探索/" itemprop="url" rel="index">
                    <span itemprop="name">技术探索</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>虽然Python 3早在2008年就发布了，但是似乎Python 3的使用率仍然不高(<a href="https://twitter.com/pycharm/status/865659029460209664" target="_blank" rel="external">来自PyCharm的一个统计</a>)。本文将在四个方面对Python 2和Python 3进行对比。</p>
<h3 id="兼容性"><a href="#兼容性" class="headerlink" title="兼容性"></a>兼容性</h3><p>这个大概是许多Python 2用户不愿意转向Python 3的最重要原因。但是根据<a href="http://py3readiness.org/" target="_blank" rel="external">py3readiness</a>的数据，将近96%的使用最多的Python包已经支持了Python 3。<br>而根据<a href="https://www.python.org/dev/peps/pep-0373/" target="_blank" rel="external">PEP 373</a>，Python 2将于2020年停止维护。<a href="http://www.python3statement.org/" target="_blank" rel="external">许多流行的Python项目也声明将于2020年以前停止对Python 2的支持</a>。<br>Python最流行的Web框架Django也声明了，<a href="https://docs.djangoproject.com/en/dev/faq/install/#what-python-version-should-i-use-with-django" target="_blank" rel="external">Django1.11将是最后一个支持Python 2的版本</a>。</p>
<h3 id="Python-3的新特性-截止到Python-3-6"><a href="#Python-3的新特性-截止到Python-3-6" class="headerlink" title="Python 3的新特性(截止到Python 3.6)"></a>Python 3的新特性(截止到Python 3.6)</h3><p>这里简述几个比较重要的</p>
<ol>
<li>类型注解。它允许你给函数增加一些说明的信息</li>
<li>标准库asyncio提供了内置的异步IO支持。不再需要gevent，tornado等第三方库</li>
<li>lazy化。许多函数例如range，map，dict.keys不再直接返回list，而是返回一个可迭代对象</li>
<li>更清晰明确的字符串表示。str表示Unicode字符串，bytes表示二进制数据</li>
</ol>
<h3 id="性能"><a href="#性能" class="headerlink" title="性能"></a>性能</h3><p><a href="https://speakerdeck.com/playpauseandstop/python-3-dot-6-and-performance-a-love-story" target="_blank" rel="external">PyCon2017有一个关于Python 3.6性能的分享</a>，得出的结论如下：</p>
<blockquote>
<p>Python 2.7 is still fastest Python<br>Python 3.5 much faster Python 3.4<br>Python 3.6 faster Python 3.5<br>Python 3.7 has some significant improvements already</p>
</blockquote>
<p><a href="https://speed.python.org/comparison/?exe=12%2BL%2B3.6%2C12%2BL%2B2.7&amp;ben=616%2C617%2C618%2C619%2C620%2C621%2C622%2C623%2C624%2C625%2C626%2C627%2C628%2C629%2C630%2C631%2C632%2C680%2C633%2C634%2C635%2C636%2C637%2C638%2C639%2C640%2C641%2C642%2C643%2C644%2C645%2C646%2C647%2C648%2C681%2C649%2C650%2C651%2C652%2C653%2C654%2C655%2C656%2C657%2C658%2C659%2C660%2C661%2C682%2C662%2C663%2C664%2C665%2C666%2C667%2C669%2C668%2C670%2C671%2C672%2C673%2C674%2C675%2C678%2C677%2C676%2C679&amp;env=1&amp;hor=false&amp;bas=12%2BL%2B2.7&amp;chart=normal+bars" target="_blank" rel="external">这里</a>是最新Python 2.7和Python 3.6在各个基准测试上的结果，<a href="http://pyperformance.readthedocs.io/benchmarks.html#available-benchmarks" target="_blank" rel="external">这里</a>是不同测试的一些说明<br>分享截图如下(写本篇文章时的数据)：<br><img src="/images/python_speed.jpg" alt=""><br>可以看出，除了python_startup，python_startup_no_site，unpickle_pure_python三个测试的数据上，Python 3.6的性能要远远落后Python 2.7以外，其他所有的测试Python 3.6仅落后Python 2.7很少，或者相对于Python 2.7的性能有所提升</p>
<h3 id="学习成本"><a href="#学习成本" class="headerlink" title="学习成本"></a>学习成本</h3><p>不可否认，大多数关于Python的学习资料还是Python 2的，网络上各个技术论坛或技术网站涉及到Python的内容大多也是指Python 2。<br>但是另一方面，Python 3虽然增加了不少新特性，但绝大多数Python 2的问题解决方案或文档也是适用于Python 3的，而且Python 2.7作为一个过渡版本，也启到了一定的作用。而且可以预料，关于Python 3的资料会越来越多。</p>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><ol>
<li>有一个反对使用Python 3的文章<a href="https://learnpythonthehardway.org/book/nopython3.html" target="_blank" rel="external">The Case Against Python 3</a>及对它的<a href="https://eev.ee/blog/2016/11/23/a-rebuttal-for-python-3/" target="_blank" rel="external">反驳</a></li>
<li><a href="http://python.jobbole.com/87814/" target="_blank" rel="external">PyCon2017上分享的Instagram为何和如何迁移到Python 3</a>(<a href="https://www.youtube.com/watch?v=66XoCk79kjM" target="_blank" rel="external">YouTube上的视频</a>)</li>
</ol>
<h3 id="我的看法"><a href="#我的看法" class="headerlink" title="我的看法"></a>我的看法</h3><ul>
<li>未来是Python 3的</li>
<li>新项目可以完全使用Python 3，老的项目可以根据项目的状况选择是否迁移到Python 3</li>
<li>就学习Python而言，因为大部分的资料仍然是Python 2的，可以根据自己的计算机基础选择Python 2或者Python 3，比选择更重要的是踏实学和实践</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/10/27/Python多进程写文件时的一些探究/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhaohui">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhaohui's 小站">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/27/Python多进程写文件时的一些探究/" itemprop="url">Python多进程写文件时的一些探究</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-10-27T20:48:41+08:00">
                2017-10-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术探索/" itemprop="url" rel="index">
                    <span itemprop="name">技术探索</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="问题提出"><a href="#问题提出" class="headerlink" title="问题提出"></a>问题提出</h3><p>在没有并发控制的情况下，Python多进程向同一个文件写数据(限制单次写入数据大小)是安全的吗？<br>这里的安全是指：</p>
<ol>
<li>不会有进程的日志丢失（被覆盖）</li>
<li>两次写入的数据不会相互混着输出（譬如A进程单次写入aaaa，B进程写入bbbb，最后的日志不会出现aaababbb）</li>
</ol>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>首先，我做了四个测试，测试代码如下(test.py)：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> sys</div><div class="line"><span class="keyword">import</span> time</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestBase</span><span class="params">(object)</span>:</span></div><div class="line">    buffering = <span class="number">-1</span></div><div class="line">    test_filename = <span class="keyword">None</span></div><div class="line">    f = <span class="keyword">None</span></div><div class="line"></div><div class="line"><span class="meta">    @classmethod</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">init_file</span><span class="params">(cls)</span>:</span></div><div class="line">        <span class="keyword">assert</span> cls.test_filename <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span></div><div class="line">        cls.f = open(cls.test_filename, <span class="string">"w"</span>, buffering=cls.buffering)</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test1</span><span class="params">(TestBase)</span>:</span></div><div class="line">    <span class="string">"""测试一</span></div><div class="line"><span class="string">    * buffering参数默认</span></div><div class="line"><span class="string">    * 无自定义buffer控制</span></div><div class="line"><span class="string">    * 文件在进程fork前打开</span></div><div class="line"><span class="string">    """</span></div><div class="line">    test_filename = <span class="string">'file1.tmp'</span></div><div class="line"></div><div class="line"><span class="meta">    @classmethod</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(cls, char, process)</span>:</span></div><div class="line">        start_time = time.time()</div><div class="line">        chars = <span class="string">"%s\n"</span> % (char * <span class="number">10</span>)</div><div class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> range(int(<span class="number">1e5</span>)):</div><div class="line">            cls.f.write(chars)</div><div class="line">        cls.f.close()</div><div class="line">        <span class="keyword">print</span> <span class="string">"%s consume %ss"</span> % (process, time.time() - start_time)</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test2</span><span class="params">(Test1)</span>:</span></div><div class="line">    <span class="string">"""测试二</span></div><div class="line"><span class="string">    * 设置buffering参数</span></div><div class="line"><span class="string">    * 无自定义buffer控制</span></div><div class="line"><span class="string">    * 文件在进程fork前打开</span></div><div class="line"><span class="string">    """</span></div><div class="line">    buffering = <span class="number">1024</span></div><div class="line">    test_filename = <span class="string">'file2.tmp'</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test3</span><span class="params">(TestBase)</span>:</span></div><div class="line">    <span class="string">"""测试三</span></div><div class="line"><span class="string">        * 设置buffering参数</span></div><div class="line"><span class="string">        * 自定义buffer控制</span></div><div class="line"><span class="string">        * 文件在进程fork前打开</span></div><div class="line"><span class="string">        """</span></div><div class="line">    buffering = <span class="number">1024</span></div><div class="line">    test_filename = <span class="string">'file3.tmp'</span></div><div class="line"></div><div class="line"><span class="meta">    @classmethod</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(cls, char, process)</span>:</span></div><div class="line">        buffer_size = cls.buffering</div><div class="line">        start_time = time.time()</div><div class="line">        chars = <span class="string">"%s\n"</span> % (char * <span class="number">10</span>)</div><div class="line">        buffer_used = <span class="number">0</span></div><div class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> range(int(<span class="number">1e5</span>)):</div><div class="line">            <span class="keyword">if</span> buffer_used + len(chars) &gt;= buffer_size:</div><div class="line">                cls.f.flush()</div><div class="line">                buffer_used = <span class="number">0</span></div><div class="line">            cls.f.write(chars)</div><div class="line">            buffer_used += len(chars)</div><div class="line">        cls.f.close()</div><div class="line">        <span class="keyword">print</span> <span class="string">"%s consume %ss"</span> % (process, time.time() - start_time)</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test4</span><span class="params">(Test3)</span>:</span></div><div class="line">    <span class="string">"""测试四</span></div><div class="line"><span class="string">        * 设置buffering参数</span></div><div class="line"><span class="string">        * 自定义buffer控制</span></div><div class="line"><span class="string">        * 文件在进程fork后打开</span></div><div class="line"><span class="string">        """</span></div><div class="line">    test_filename = <span class="string">'file4.tmp'</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    test_num = int(sys.argv[<span class="number">1</span>])</div><div class="line">    test_class_map = &#123;</div><div class="line">        <span class="number">1</span>: Test1,</div><div class="line">        <span class="number">2</span>: Test2,</div><div class="line">        <span class="number">3</span>: Test3,</div><div class="line">        <span class="number">4</span>: Test4,</div><div class="line">    &#125;</div><div class="line">    test_class = test_class_map.get(test_num)</div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> test_class:</div><div class="line">        sys.stderr.write(<span class="string">"unknown test_num"</span>)</div><div class="line">        sys.exit(<span class="number">1</span>)</div><div class="line"></div><div class="line">    <span class="comment"># 前3个测试，在fork前打开文件</span></div><div class="line">    <span class="keyword">if</span> test_num &lt;= <span class="number">3</span>:</div><div class="line">        test_class.init_file()</div><div class="line"></div><div class="line">    <span class="keyword">if</span> os.fork() == <span class="number">0</span>:  <span class="comment"># child process</span></div><div class="line">        char = <span class="string">'a'</span></div><div class="line">        process = <span class="string">'child'</span></div><div class="line">    <span class="keyword">else</span>:  <span class="comment"># parent process</span></div><div class="line">        char = <span class="string">'b'</span></div><div class="line">        process = <span class="string">'parent'</span></div><div class="line"></div><div class="line">    <span class="comment"># 第四个测试，在fork后打开文件</span></div><div class="line">    <span class="keyword">if</span> test_num == <span class="number">4</span>:</div><div class="line">        test_class.init_file()</div><div class="line">    test_class.run(char, process)</div></pre></td></tr></table></figure></p>
<p>在都是利用os.fork实现多进程(<a href="https://docs.python.org/3/library/multiprocessing.html#contexts-and-start-methods" target="_blank" rel="external">在Unix下，multiprocessing库默认也是使用os.fork</a>)写一个文件的情况下，四个测试主要有以下不同：</p>
<ul>
<li>在调用Python内建函数<a href="https://docs.python.org/2/library/functions.html#open" target="_blank" rel="external">open</a>时，是否设置buffering，默认是-1(也是Python默认值)</li>
<li>是否有自定义buffering控制。这里的自定义buffering控制是指，上层代码检测在进行此次写入时，是否会造成缓冲区溢出(大于buffer_size)，如果溢出，先进行flush操作，再进行write操作</li>
<li>文件是在fork前还是之后打开</li>
</ul>
<p>分别执行<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">python test.py 1</div><div class="line">python test.py 2</div><div class="line">python test.py 3</div><div class="line">python test.py 4</div></pre></td></tr></table></figure></p>
<p>得出结果如下：<br>测试环境：MAC OS X</p>
<table>
<thead>
<tr>
<th style="text-align:center">测试</th>
<th style="text-align:center">Python 2.7.13</th>
<th style="text-align:center">Python 3.6.2</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Test1</td>
<td style="text-align:center">无丢失发生，数据混着输出</td>
<td style="text-align:center">正常</td>
</tr>
<tr>
<td style="text-align:center">Test2</td>
<td style="text-align:center">无丢失发生，数据混着输出</td>
<td style="text-align:center">正常</td>
</tr>
<tr>
<td style="text-align:center">Test3</td>
<td style="text-align:center">正常</td>
<td style="text-align:center">正常</td>
</tr>
<tr>
<td style="text-align:center">Test4</td>
<td style="text-align:center">数据丢失一半</td>
<td style="text-align:center">数据丢失一半</td>
</tr>
</tbody>
</table>
<h3 id="结果分析"><a href="#结果分析" class="headerlink" title="结果分析"></a>结果分析</h3><h4 id="为什么Python-2和Python-3的结果不一样呢？"><a href="#为什么Python-2和Python-3的结果不一样呢？" class="headerlink" title="为什么Python 2和Python 3的结果不一样呢？"></a>为什么Python 2和Python 3的结果不一样呢？</h4><p>Python 3使用了New I/O(<a href="https://www.python.org/dev/peps/pep-3116/" target="_blank" rel="external">PEP 3116</a>)。而一个重要的变化是，Python 3在自己这一层实现了buffer机制。<a href="https://github.com/python/cpython/blob/2.7/Objects/fileobject.c#L1856" target="_blank" rel="external">Python 2写文件使用的是C库函数fwrite</a>，而buffer机制完全依靠fwrite。<a href="https://github.com/python/cpython/blob/3.6/Python/fileutils.c#L1268" target="_blank" rel="external">Python 3使用的是write系统调用</a>，buffer机制是自己实现的</p>
<h4 id="为什么在Python-2中，Test3是正常的呢？"><a href="#为什么在Python-2中，Test3是正常的呢？" class="headerlink" title="为什么在Python 2中，Test3是正常的呢？"></a>为什么在Python 2中，Test3是正常的呢？</h4><p>这个推断是在buffer满时，fwrite的处理是不能保证多进程安全的。而在上层代码强制flush的情况下，能保证数据正常写入文件</p>
<h4 id="为什么在fork之后打开文件时，数据会丢失呢？"><a href="#为什么在fork之后打开文件时，数据会丢失呢？" class="headerlink" title="为什么在fork之后打开文件时，数据会丢失呢？"></a>为什么在fork之后打开文件时，数据会丢失呢？</h4><p>这个和fork操作对每个文件的current stream position(即调用tell方法返回的)的处理有关，参考<a href="http://blog.csdn.net/u011508527/article/details/46878205" target="_blank" rel="external">这里</a></p>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><h4 id="Nginx的ngx-http-log-module模块的I-O处理"><a href="#Nginx的ngx-http-log-module模块的I-O处理" class="headerlink" title="Nginx的ngx_http_log_module模块的I/O处理"></a>Nginx的ngx_http_log_module模块的I/O处理</h4><p>根据<a href="http://nginx.org/en/docs/http/ngx_http_log_module.html#open_log_file_cache" target="_blank" rel="external">文档</a>，说明了在启用buffering时，写入文件的时机：</p>
<blockquote>
<p>When buffering is enabled, the data will be written to the file:<br>if the next log line does not fit into the buffer;<br>if the buffered data is older than specified by the flush parameter (1.3.10, 1.2.7);<br>when a worker process is re-opening log files or is shutting down.</p>
</blockquote>
<p>根据<a href="https://github.com/phusion/nginx/blob/stable-1.2/src/os/unix/ngx_files.c#L68" target="_blank" rel="external">这儿的源代码</a>，Nginx会根据NGX_HAVE_PWRITE宏的设置，使用pwrite或者write</p>
<h4 id="关于fwrite，write，pwrite的一些讨论："><a href="#关于fwrite，write，pwrite的一些讨论：" class="headerlink" title="关于fwrite，write，pwrite的一些讨论："></a>关于fwrite，write，pwrite的一些讨论：</h4><ol>
<li><a href="https://linux.die.net/man/3/pwrite" target="_blank" rel="external">pwrite(3) - Linux man page</a></li>
<li><a href="https://stackoverflow.com/questions/7592822/what-are-the-advantages-of-pwrite-and-pread-over-fwrite-and-fread" target="_blank" rel="external">What are the advantages of pwrite and pread over fwrite and fread?</a></li>
<li><a href="http://tsecer.blog.163.com/blog/static/1501817201311284223689/" target="_blank" rel="external">linux下多进程写入文件的原子性</a></li>
</ol>
<p>引用1</p>
<blockquote>
<p>Atomic/non-atomic: A write is atomic if the whole amount written in one operation is not interleaved with data from any other process. This is useful when there are multiple writers sending data to a single reader. Applications need to know how large a write request can be expected to be performed atomically. This maximum is called {PIPE_BUF}. This volume of IEEE Std 1003.1-2001 does not say whether write requests for more than {PIPE_BUF} bytes are atomic, but requires that writes of {PIPE_BUF} or fewer bytes shall be atomic.</p>
</blockquote>
<p>及根据2，可知在写入少于{PIPE_BUF}bytes的数据时，write及pwrite系统调用应该是原子的<br>而fwrite相对于write/pwrite有内置buffering，在没有自定义buffering的情况下，能很大的提升写文件的性能</p>
<h4 id="Python的logging模块"><a href="#Python的logging模块" class="headerlink" title="Python的logging模块"></a>Python的logging模块</h4><p>logging模块的FileHandler也是采用的open函数，在多进程情况下，也符合以上讨论</p>
<h4 id="Java的I-O处理"><a href="#Java的I-O处理" class="headerlink" title="Java的I/O处理"></a>Java的I/O处理</h4><p>跟据<a href="https://www.python.org/dev/peps/pep-3116/" target="_blank" rel="external">PEP 3116</a>中的描述</p>
<blockquote>
<p>The new I/O spec is intended to be similar to the Java I/O libraries, but generally less confusing.</p>
</blockquote>
<p>看来Java对I/O的处理更加类似Python 3</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/10/12/一些不错的openstack学习资料/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhaohui">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhaohui's 小站">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/12/一些不错的openstack学习资料/" itemprop="url">一些不错的OpenStack学习资料</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-10-12T19:58:14+08:00">
                2017-10-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术探索/" itemprop="url" rel="index">
                    <span itemprop="name">技术探索</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Keystone：<a href="http://blog.csdn.net/hejin_some/article/details/58066427" target="_blank" rel="external">OpenStack组件 — Keystone认证功能实现原理</a><br>nova-api的WSGI：<a href="http://wsfdl.com/openstack/2013/10/18/%E7%90%86%E8%A7%A3nova-api%E7%9A%84WSGI%E6%A1%86%E6%9E%B6.html" target="_blank" rel="external">深入理解 nova-api 的 WSGI</a><br>Nova创建虚拟机整体流程：<a href="https://blog.apporc.org/2016/04/nova-%E5%88%9B%E5%BB%BA%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%B5%81%E7%A8%8B/" target="_blank" rel="external">nova: 创建虚拟机流程</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/09/30/关于时间的一些杂想/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhaohui">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhaohui's 小站">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/30/关于时间的一些杂想/" itemprop="url">关于时间的一些杂想</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-09-30T21:30:20+08:00">
                2017-09-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/生活杂想/" itemprop="url" rel="index">
                    <span itemprop="name">生活杂想</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>越来越能感觉到“一寸光阴一寸金”的含义。人生中的每件事无不与时间关系很大。<br>娱乐，思考，学习，睡觉都需要时间。<br>关于时间和钱。时间是能换来钱的，就像一个人工作，时薪虽然不高，时间长了，也能赚到一大笔钱。而金钱几乎是人类社会最重要的一种东西，金钱多了，许多事情不用斤斤计较，在生病时也能找到最好的医生，某种程度上也能换来时间。但是时间和金钱的属性是不一样的，时间是生来就有的，但是没法被保存，金钱需要你去努力争取，但却能被存储。两者都很重要，但谁大谁小，却没法确认。</p>
<p>如果把时间看成一个维度，我们每个人的一生就像从四维空间的一个点走到另一个点。这样的话，一个人的少年，成年只是一个人的属性。所谓老人和孩子也就是属性的不同而已了。我们也似乎没必要把年龄看得非常重。</p>
<p>但是对于一个人，时间总是在不断流逝的，在确定的时间内，做出最有成效的事情，总是没有错误的。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/09/26/Hello-Hexo/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhaohui">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhaohui's 小站">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/26/Hello-Hexo/" itemprop="url">Hello, Hexo</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-09-26T22:13:36+08:00">
                2017-09-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/生活杂想/" itemprop="url" rel="index">
                    <span itemprop="name">生活杂想</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>因为WordPress的重量，又不能很好的支持Markdown，博客正式转用<a href="https://hexo.io/" target="_blank" rel="external">Hexo</a>了。<br>迁移过程主要参照了<a href="http://www.jianshu.com/p/fd233d967e88" target="_blank" rel="external">博客搬家记：从 Wordpress 到 Hexo+Github</a>。<br>使用hexo-migrator-wordpress插件迁移的过程中，遇到了一些问题，虽然经过折腾一一化解，但是最终的效果还是只能算差强人意（<a href="http://wordpress.dahui1990.com/" target="_blank" rel="external">旧博客传送门</a>）。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/09/07/Django-REST-framework小探/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhaohui">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhaohui's 小站">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/07/Django-REST-framework小探/" itemprop="url">Django REST framework小探</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-09-07T19:19:26+08:00">
                2017-09-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术探索/" itemprop="url" rel="index">
                    <span itemprop="name">技术探索</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>偶然发现<br>1. 不带CSRF信息<br>2. 没有session相关的cookie<br>也能正常访问API</p>
<p>调试发现，接口的访问通过REST framework的ApiView，而这个View的authentication_classes和permission_classes, throttle_classes都是使用的默认的<br>在默认情况下，authentication_classes的值是：</p>
<p><pre>‘DEFAULT_AUTHENTICATION_CLASSES’: (<br>    ‘rest_framework.authentication.SessionAuthentication’,<br>    ‘rest_framework.authentication.BasicAuthentication’<br>)</pre><br>permission_classes的值是：</p>
<p><pre>‘DEFAULT_PERMISSION_CLASSES’: (<br>    ‘rest_framework.permissions.AllowAny’,<br>)</pre><br>throttle_classes的值是：</p>
<p><pre>‘DEFAULT_THROTTLE_CLASSES’: (),</pre><br>而根据Django REST framework的<a href="http://www.django-rest-framework.org/api-guide/authentication/" target="_blank" rel="external">设定</a>（<a href="https://github.com/encode/django-rest-framework/blob/3.2.2/rest_framework/authentication.py#L125" target="_blank" rel="external">相关代码</a>）:</p>
<p><pre>Authentication is the mechanism of associating an incoming request with a set of identifying credentials, such as the user the request came from, or the token that it was signed with. The <a href="http://www.django-rest-framework.org/api-guide/permissions/" target="_blank" rel="external">permission</a> and <a href="http://www.django-rest-framework.org/api-guide/throttling/" target="_blank" rel="external">throttling</a> policies can then use those credentials to determine if the request should be permitted.</pre><br>authentication本身并不决定请求是否应该被拒绝，所以在没有用户登录的情况下(没有session相关cookie)，请求仍能到达业务处理函数</p>
<p>另一个问题是，CSRF为何没有发挥作用，原因是：<br>根据<a href="https://github.com/encode/django-rest-framework/blob/3.2.2/rest_framework/views.py#L134" target="_blank" rel="external">这里</a>：</p>
<p><pre><span class="pl-c">#</span> Note: session based authentication is explicitly CSRF validated,<br><span class="pl-c">#</span> all other authentication is CSRF exempt.</pre><br>只有SessionAuthentication才会做CSRF检查，而根据SessionAuthentication的<a href="https://github.com/encode/django-rest-framework/blob/3.2.2/rest_framework/authentication.py#L124" target="_blank" rel="external">代码</a>，检测到没有活跃用户，就不再做CSRF防御了</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/09/04/高晓松的脱口秀/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhaohui">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhaohui's 小站">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/04/高晓松的脱口秀/" itemprop="url">高晓松的脱口秀</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-09-04T01:08:17+08:00">
                2017-09-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/生活杂想/" itemprop="url" rel="index">
                    <span itemprop="name">生活杂想</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>从，奇葩说，看到晓松奇谈，晓说，晓松说，晓说2017<br>一路走来，对高晓松有了不少自己的看法<br>家境优越，早年成名，因醉驾做过半年牢<br>看脱口秀，能感受到他知识范围很广，其中，讲的最多的领域应该是历史，文学，音乐，电影<br>能感觉到他经历丰富，圈子广，情商高，的确也很有才华<br>能平淡的对待世界，有自己的看法与处事方式，而不偏激，不虚荣，不自大。<br>对于我而言，很喜欢他讲述的方式和态度，客观事实（虽然很多待考证或者难以考证）偏多，加上不偏激的解说<br>从最开始的完全顶礼膜拜，后来也慢慢趋于平和<br>慢慢的有了一些疑问（譬如对林语堂的前后的观点的变化，金瓶梅中的一夫多妾与经常提到的一夫一妻一妾多婢多姬），和发现了不少重复，面向大众（可能有时候会受政治影响，着重讲一些东西），性格过于开朗能说（而可能有时候会缺少一些准确），也大概是有些审美疲劳</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/09/02/中关村创业大街/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhaohui">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhaohui's 小站">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/02/中关村创业大街/" itemprop="url">中关村创业大街</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-09-02T16:50:25+08:00">
                2017-09-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/生活杂想/" itemprop="url" rel="index">
                    <span itemprop="name">生活杂想</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>参加百度开发者沙龙，发现自己是第一次去中关村创业大街<br>这种规模的，免费的沙龙是第一次去<br>4个讲师，2个技术，一个运营，一个产品<br>半场离场，一个原因是座位不好，有些压抑。更主要的原因是感觉演讲的内容并不是自己真正需要的。<br>进而想到这样的沙龙，听众繁杂，每人的知识基础和诉求也不一样，也很难完全符合某一个人的口味<br>随着年龄的增长，慢慢认识到除技术之外的东西的重要性，产品，推广，运营<br>也慢慢对技术有了一个更加全面的认识，大部分的技术应该以产品为主，产品和技术协调共同达成公司(部门)的目标<br>对于技术本身而言，大部分是，比较重要的是整体的架构，各个服务的调用关系，各个组件通信的方式，各个组件存在的目的。在整体架构正确的情况下，然后是单个项目（服务）的结构，代码的组织方式，主要的执行流程。之后可能才是具体的代码，包含某一个功能的具体实现方式，某些函数的设计，如何把代码写的简单可读而稳定，代码风格等。当然，根据不同场景，某些核心功能的核心模块的算法设计和实现也很重要。<br>越来越多的思考，一个公司的成功，一个产品的成功，社会及世界的运行方式，人们协作的方式。与此同时，也更加清楚的认识了自己的特点，局限性，擅长的地方与很笨拙的地方。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/03/16/使用redis的Sorted-Set解决“助我夺宝”/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhaohui">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhaohui's 小站">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/03/16/使用redis的Sorted-Set解决“助我夺宝”/" itemprop="url">使用Redis的Sorted Set解决“助我夺宝”</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-03-16T20:01:46+08:00">
                2017-03-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术探索/" itemprop="url" rel="index">
                    <span itemprop="name">技术探索</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>助我夺宝需求描述如下：<br>1.用户可以助威好友<br>2.用户按照助威数和最后一个助威的时间排名<br>3.排名特定区间的用户可以获得奖品，如排名1-3获得奖品一，排名4-8可以获得奖品二，等等<br>4.实时获取用户当前排名，以及距离下一区间奖品需要的助威数</p>
<p>问题的难点在于用户的排名是不断变化中的，利用redis的Sorted Set却可以比较好的完成这项需求</p>
<p>首先可以用关系型数据库mysql存储<br>prize表 – 奖品信息<br>user表 – 用户信息<br>access_record表 – 用户助威好友的记录</p>
<p>然后设置Sorted Set的<br>member – 用户ID<br>score – 助威数*1e10 + (1e10 - 助威记录ID) # 这里假设助威记录ID小于1e10(根据redis文档，score的取值范围是-2^53与2^53之间)，助威记录ID按照时间递增</p>
<p>然后就可以提供以下功能：<br>助威 – 先使用zscore取出旧的score，然后可以算出之前的助威数，将助威数加1，再用zadd将新的score存入redis<br>计算用户排名 – 使用zrevrank<br>获取排名前num的用户 – 使用zrevrange<br>计算某一用户距离下一区间奖品需要的助威数 – 先取出此用户对应rank和score,根据rank计算下一排名区间的最低rank(如4-8名获得奖品二，8-15名获得奖品三，用户当前rank为10，则下一区间奖品最低rank为8)，使用zrevrange得到最低rank对应的score_min,根据score_min和score分别计算得到助威数help_num_min和help_num,则help_num_min+1-help_num即是需要的助威数</p>
<p>假设参与排名的用户数为n个，以上用到的redis操作中，zadd, zrevrank的时间复杂度为O(log(n)),zrevrang根据取出的元素的个数m时间复杂度为O(log(n)+m),zscore的时间复杂度为O(1)</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          
            <img class="site-author-image" itemprop="image"
              src="/images/avatar.jpeg"
              alt="zhaohui" />
          
            <p class="site-author-name" itemprop="name">zhaohui</p>
            <p class="site-description motion-element" itemprop="description">和平，宁静，奋斗</p>
        </div>

        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
            
              <a href="/archives/">
            
                <span class="site-state-item-count">46</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">45</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zhaohui</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" href="https://hexo.io">Hexo</a></div>

  <span class="post-meta-divider">|</span>

  <div class="theme-info">Theme &mdash; <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.2</div>


        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>


  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  








  





  

  

  

  

  

  

</body>
</html>
